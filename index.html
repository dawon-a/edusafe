<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>교육시설 안전성평가 대상 확인</title>
<style>
  :root{
    --brand:#133e8d; --ink:#222; --muted:#6b7280; --card:#fff;
    --btn:#0f3a8a; --btn-t:#fff; --ok:#1e7b1e; --bad:#f59e0b;
    --soft-ok:#e8f5e9; --soft-bad:#fff7ed; --shadow:0 8px 24px rgba(0,0,0,.08);
    --err:#d92d20; --err-bg:#fee4e2;
    /* 추가 색상 (파스텔 계열) */
    --pastel-line: rgba(147,197,253,0.95); /* pastel blue */
    --pastel-fill: rgba(173,216,230,0.28); /* light pastel */
    --pastel-point: rgba(110,231,183,0.9); /* pastel green */
    --tooltip-bg: rgba(17,24,39,0.95);
    --tooltip-fg: #fff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:#dfe8f5;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","맑은 고딕",sans-serif;
    color:var(--ink);
  }
  .appbar{
    background:var(--brand);
    color:#fff;
    padding:18px 20px;
    position:sticky;
    top:0;
    z-index:100;
  }
  .title{
    text-align:center;
    font-weight:800;
    font-size:28px;
    letter-spacing:-.5px;
  }
  .wrap{
    max-width:980px;
    margin:24px auto;
    padding:0 16px;
    position:relative;
  }
  .card{
    background:var(--card);
    border-radius:16px;
    box-shadow:var(--shadow);
    padding:18px;
  }
  .row{
    display:grid;
    grid-template-columns:150px 1fr;
    gap:14px;
    align-items:center;
    margin:10px 0;
  }
  .label{font-weight:700}
  .req{color:#dc2626;margin-left:2px}
  .hint{color:#6b7280;font-size:12px}
  .field{
    display:flex;
    gap:8px;
    align-items:flex-start;
    flex-wrap:wrap;
  }
  input,select{
    width:100%;
    max-width:260px;
    padding:10px 12px;
    border:1px solid #c7d2fe;
    border-radius:8px;
    background:#f8fbff;
    font-size:16px;
    outline:none;
  }
  input:focus,select:focus{box-shadow:0 0 0 3px rgba(19,62,141,.15)}
  .radio{display:flex;gap:16px}
  .btn{
    background:var(--btn);
    color:var(--btn-t);
    border:0;
    padding:12px 18px;
    border-radius:10px;
    font-weight:800;
    cursor:pointer;
  }
  .btn:active{transform:translateY(1px)}
  .notice{
    margin-top:10px;
    background:#fff7ed;
    color:#92400e;
    border-left:5px solid #f59e0b;
    padding:10px 12px;
    border-radius:10px;
    font-weight:600;
    text-align:center;
  }
  .err{
    display:none;
    font-size:12px;
    color:#d92d20;
    background:#fee4e2;
    padding:6px 8px;
    border-radius:8px;
    margin-top:4px;
  }
  .has-error input,
  .has-error select{
    border-color:#d92d20;
  }
  .resultbox{
    display:none;
    margin-top:14px;
    border-left:6px solid var(--ok);
    border-radius:12px;
    padding:14px;
    background:var(--soft-ok);
  }
  .resultbox.bad{
    background:var(--soft-bad);
    border-left-color:var(--bad);
  }
  .result-title{
    font-weight:800;
    margin-bottom:6px;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .result-title.hidden{display:none}
  .ico{font-size:18px}
  .guide{
    margin-top:10px;
    padding:10px 12px;
    border-radius:10px;
    background:#f1f5ff;
    color:#1f3b74;
    font-size:14px;
  }
  .guide a{
    color:#0f3a8a;
    font-weight:700;
    text-decoration:none;
    border-bottom:1px solid currentColor;
    margin-right:8px;
    display:inline-block;
    margin-top:4px;
  }
  /* 광고: 스크롤 시 따라오는 고정 배너(데스크탑) */
  .ad{
    position:fixed;
    right:16px;
    top:80px;
    z-index:9999;
    text-align:right;
  }
  .ad .unit{
    display:inline-block;
    background:#fff;
    border-radius:14px;
    box-shadow:var(--shadow);
    padding:10px;
  }
  .ad img{height:50px;vertical-align:middle}
  .ad p{margin:6px 0 0 0;font-size:12px;color:#4b5563}
  .stats{
    margin-top:24px;
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  .panel{
    background:#fff;
    border-radius:14px;
    box-shadow:var(--shadow);
    padding:14px;
  }
  .panel h3{margin:0 0 10px 0;font-size:16px}
  /* 그래프를 조금 더 작게 (기본 160 -> 120) */
  #trend{width:100%;height:120px;display:block}
  /* 툴팁 */
  .chart-tooltip{
    position:fixed;
    pointer-events:none;
    background:var(--tooltip-bg);
    color:var(--tooltip-fg);
    padding:8px 10px;
    border-radius:8px;
    font-size:13px;
    box-shadow:0 6px 18px rgba(2,6,23,.4);
    transform:translate(-50%, -120%);
    white-space:nowrap;
    z-index:2000;
    display:none;
  }

  @media (max-width:640px){
    .row{grid-template-columns:1fr}
    .ad{
      position:static;
      margin-bottom:8px;
      text-align:center;
    }
    .ad .unit{width:100%}
    /* 모바일: 결과창을 하단 패널처럼 보이게 */
    #result{
      position:fixed;
      left:0;right:0;bottom:0;
      margin:0;
      border-radius:16px 16px 0 0;
      max-height:50vh;
      overflow:auto;
      z-index:500;
    }
    #trend{height:100px}
  }
</style>
</head>
<body>
<header class="appbar" role="banner">
  <div class="title">교육시설 안전성평가 대상 확인</div>
</header>

<main class="wrap" role="main">
  <!-- 광고: 스크롤 따라오는 배너 -->
  <aside class="ad" aria-label="스폰서">
    <a class="unit" href="http://dawonsafety.com/board/board_view?code=estimate&no=16" target="_blank" rel="noopener">
      <img src="dawon-logo.png" alt="다원안전" />
      <p class="muted">견적 바로가기</p>
    </a>
  </aside>

  <!-- 입력 카드 (원본 그대로 유지) -->
  <section class="card" aria-labelledby="formTitle">
    <h2 id="formTitle" class="visually-hidden" style="position:absolute;left:-9999px">입력</h2>

    <div class="row" id="rowScope">
      <div class="label">공사 위치<span class="req">*</span></div>
      <div>
        <div class="radio" role="radiogroup">
          <label><input type="radio" name="scope" value="교내"> 교내</label>
          <label><input type="radio" name="scope" value="교외"> 교외</label>
        </div>
        <div class="err" id="errScope" aria-live="polite">위치구분을 선택해주세요</div>
      </div>
    </div>

    <div class="row" id="rowW23">
      <div class="label">학교경계 이격거리(m)<span class="req">*</span></div>
      <div>
        <div class="field">
          <input id="w23" type="number" placeholder="예: 12" inputmode="decimal" aria-describedby="w23Help">
        </div>
        <div id="w23Help" class="hint">예: 학교 경계선(담장 등)에서 공사장 경계까지의 직선거리(m)</div>
        <div class="err" id="errW23" aria-live="polite">이격거리를 입력해주세요</div>
      </div>
    </div>

    <div class="row">
      <div class="label">영향거리(m)</div>
      <div>
        <div class="field">
          <input id="w31" type="number" readonly placeholder="자동 계산">
          <span class="hint">※ 굴착/부지 조건에 따라 자동 산정</span>
        </div>
      </div>
    </div>

    <div class="row" id="rowW24">
      <div class="label">굴착깊이 h1(m)</div>
      <div>
        <div class="field">
          <input id="w24" type="number" placeholder="예: 3.0" inputmode="decimal" aria-describedby="w24Help">
        </div>
        <div id="w24Help" class="hint">예: 지표면에서 가장 깊은 굴착 저면까지의 깊이(m)</div>
        <div class="err" id="errW26need" aria-live="polite">굴착·단차 입력 시 ‘부지높이 관계’를 선택해주세요</div>
      </div>
    </div>

    <div class="row" id="rowW25">
      <div class="label">부지단차 h2(m)</div>
      <div>
        <div class="field">
          <input id="w25" type="number" placeholder="예: 1.5" inputmode="decimal" aria-describedby="w25Help">
        </div>
        <div id="w25Help" class="hint">예: 학교 부지와 공사부지 사이의 높이 차이(m)</div>
      </div>
    </div>

    <div class="row" id="rowW26">
      <div class="label">부지높이 관계</div>
      <div>
        <div class="field">
          <select id="w26" aria-describedby="w26Help">
            <option value="">선택</option>
            <option value="같음">같음</option>
            <option value="낮음">낮음</option>
            <option value="높음">높음</option>
          </select>
          <span id="w26Help" class="hint">※ 굴착·단차 입력 시 필수</span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="label">구조물 높이(m)</div>
      <div>
        <div class="field">
          <input id="w27" type="number" placeholder="예: 11.0" inputmode="decimal" aria-describedby="w27Help">
        </div>
        <div id="w27Help" class="hint">예: 지표면부터 구조물 최상단까지 높이(m) / *구조물 : 건축·토목·가설 구조물</div>
      </div>
    </div>

    <div class="row">
      <div class="label">층수</div>
      <div>
        <div class="field">
          <input id="w28" type="number" placeholder="예: 5" inputmode="numeric" aria-describedby="w28Help">
        </div>
        <div id="w28Help" class="hint">예: 지상층 기준 층수(지하층 제외 또는 별도 기준에 따라 적용)</div>
      </div>
    </div>

    <!-- ✅ 건축물 높이 + 에러 -->
    <div class="row" id="rowW29">
      <div class="label">건축물 높이(m)</div>
      <div>
        <div class="field">
          <input id="w29" type="number" placeholder="예: 15.0" inputmode="decimal" aria-describedby="w29Help">
        </div>
        <div id="w29Help" class="hint">예: 지표면부터 건축물 최상단까지 높이(m)</div>
        <div class="err" id="errW29" aria-live="polite">층수를 입력한 경우 건축물 높이(m)를 함께 입력해주세요</div>
      </div>
    </div>

    <div class="row">
      <div class="label">공사종류</div>
      <div>
        <div class="field">
          <select id="w30">
            <option value="">선택</option>
            <option value="터널공사">터널공사</option>
            <option value="발파공사">발파공사</option>
            <option value="건축물 해체공사(허가)">건축물 해체공사(허가)</option>
            <option value="건축물 해체공사(신고)">건축물 해체공사(신고)</option>
          </select>
        </div>
      </div>
    </div>

    <div class="notice">현장마다 상이할 수 있으니 참고용으로만 사용 바랍니다.</div>

    <div class="field" style="justify-content:flex-end;margin-top:8px">
      <button id="check" class="btn">결과확인</button>
    </div>

    <!-- 결과창 -->
    <div id="result" class="resultbox" role="status" aria-live="polite">
      <div id="resultTitle" class="result-title">
        <span id="resultIcon" class="ico" aria-hidden="true">✅</span>
        <span id="resultTitleText"></span>
      </div>
      <div id="resultMsg"></div>
      <div id="nextGuide" class="guide" style="display:none">
        <strong>👉다음 단계 안내</strong><br>
        ① 서류 작성 및 제출 · ② 안전성평가 검토 · ③ 안전성 보완 조치<br><br>
        제출처: 교육시설의 장 또는 감독기관의 장<br>
        제출서류: 교육시설 안전성평가서 및 관련 도서·도면 등<br>
        <a href="http://dawonsafety.com/board/board_view?code=estimate&no=16" target="_blank" rel="noopener">견적/문의 바로가기</a>
      </div>
    </div>
  </section>

  <!-- 방문자 트래픽 -->
  <section class="stats">
    <div class="panel">
      <h3>방문 현황 <span class="hint">(실시간)</span></h3>
      <div>오늘 방문: <strong id="todayCnt">0</strong>명</div>
      <canvas id="trend" width="800" height="120"></canvas>
      <!-- 툴팁을 body 레벨에 둡니다 -->
      <div id="chartTooltip" class="chart-tooltip" role="status" aria-hidden="true"></div>
    </div>
    <div class="panel">
      <h3>일자별 트래픽</h3>
      <button id="dl" class="btn">엑셀(CSV) 다운로드</button>
    </div>
  </section>
</main>

<script>
(()=>{"use strict";
/*
  교수님 스타일 주석:
  - 이 스크립트는 원본 판정 로직(입력/검증/판정)을 그대로 유지합니다.
  - 방문자 통계는 '클라이언트 저장(localStorage)' 기반의 세션+쿠키 설계를 적용했습니다.
  - 서버 동기화가 필요하면 recordVisit()의 내부에서 fetch()로 전송하도록 확장하세요.
*/

/* -------------------------
   짧은 유틸리티
--------------------------*/
const d=document,$=s=>d.querySelector(s),N=v=>Number(v)||0;
const isoDate = dt => dt.toISOString().slice(0,10);

/* -------------------------
   영향거리 계산 (원본 유지)
--------------------------*/
const calcW31=({w24,w25,w26,w27})=>{
  if(w24>=2){
    if(w26==="같음") return 1.5*w24+4;
    if(w26==="낮음") return 1.5*(w24+w25)+4;
    if(w26==="높음") return 1.5*(w24-w25)+4;
  }
  return w27||0;
};

/* -------------------------
   입력값 수집 (원본 유지)
--------------------------*/
const getVals=()=>({
  scope:d.querySelector('input[name="scope"]:checked')?.value||"",
  w23:N($("#w23").value),
  w24:N($("#w24").value),
  w25:N($("#w25").value),
  w26:$("#w26").value,
  w27:N($("#w27").value),
  w28:N($("#w28").value),
  w29:N($("#w29").value),
  w30:$("#w30").value
});

/* -------------------------
   에러/검증/판정 로직 (원본 유지)
--------------------------*/
const showErr=(rowSel, errSel, on)=>{
  const row=$(rowSel), err=$(errSel);
  if(!row || !err) return;
  if(on){
    row.classList.add("has-error");
    err.style.display="block";
  }else{
    row.classList.remove("has-error");
    err.style.display="none";
  }
};
const validateScope=()=>{
  const sel=d.querySelector('input[name="scope"]:checked');
  showErr("#rowScope","#errScope",!sel);
  return !!sel;
};
const validateW23=()=>{
  const scope=d.querySelector('input[name="scope"]:checked')?.value||"";
  if(scope==="교내"){
    showErr("#rowW23","#errW23",false);
    return true;
  }
  const v=$("#w23").value.trim();
  showErr("#rowW23","#errW23",v==="");
  return v!=="";
};
const toggleW26Required=()=>{
  const need = !!($("#w24").value) || !!($("#w25").value);
  $("#w26").required = need;
  const ok = $("#w26").value!=="" || !need;
  showErr("#rowW24","#errW26need", need && !ok);
  return ok;
};
const validateW29=()=>{
  const floors = $("#w28").value.trim();
  const bHeight = $("#w29").value.trim();
  const need = floors !== "";
  const ok = !need || bHeight !== "";
  showErr("#rowW29","#errW29", need && !ok);
  return ok;
};

["blur","input","change"].forEach(ev=>{
  d.addEventListener(ev, e=>{
    if(e.target?.id==="w23") validateW23();
    if(e.target?.name==="scope"){
      validateScope();
      validateW23();
    }
    if(["w24","w25","w26"].includes(e.target?.id)) toggleW26Required();
    if(["w28","w29"].includes(e.target?.id)) validateW29();
  }, true);
});

/* 판정 로직 그대로 유지 */
const judge=(p)=>{
  const rawW23 = $("#w23").value.trim();

  if(!p.scope && rawW23){return {type:"guide",msg:"위치구분을 선택해주세요"};}

  if(!p.scope){return {type:"guide",msg:"위치구분을 선택해주세요"};}

  if(p.scope==="교내"){
    return {type:"good",msg:"(교내)건축허가 및 건축승인에 따른 교육시설"};
  }

  if(p.scope==="교외" && !rawW23){
    return {type:"guide",msg:"이격거리를 입력해주세요"};
  }

  if(p.scope==="교외" && p.w23<=4)
    return {type:"good",msg:"(교외)학교경계로부터 직선거리 4미터 이내의 건설공사"};

  const inRange = (p.scope==="교외" && p.w23>4 && p.w23<=50);

  if(inRange && p.w28>=3 && p.w29>0 && p.w23 < p.w29){
    return {type:"good",msg:"3층 이상 건축물 또는 구조물 높이 10미터 이상인 경우"};
  }

  if(inRange && p.w27>=10 && p.w23 < p.w27){
    return {type:"good",msg:"3층 이상 건축물 또는 구조물 높이 10미터 이상인 경우"};
  }

  if(inRange && ["터널공사","발파공사","건축물 해체공사(허가)","건축물 해체공사(신고)"].includes(p.w30))
    return {type:"good",msg:p.w30};

  if(inRange && p.w24>2){
    const w31=calcW31(p);
    if(p.w23 < w31)
      return {type:"good",msg:"굴착깊이 2미터 이상인 경우"};
  }

  return {type:"bad",msg:"비대상"};
};

const render=(res)=>{
  const box=$("#result"),
        title=$("#resultTitle"),
        titleText=$("#resultTitleText"),
        icon=$("#resultIcon"),
        msg=$("#resultMsg"),
        guide=$("#nextGuide");

  box.style.display="block";
  msg.textContent=res.msg;

  if(res.type==="good"){
    box.className="resultbox";
    title.classList.remove("hidden");
    titleText.textContent="작성 대상입니다. 적용 항목:";
    icon.textContent="✅";
    guide.style.display="block";
  }else if(res.type==="bad"){
    box.className="resultbox bad";
    title.classList.remove("hidden");
    titleText.textContent="작성 비대상입니다.";
    icon.textContent="⚠️";
    guide.style.display="none";
  }else{ // 안내 문구 타입
    box.className="resultbox bad";
    title.classList.add("hidden");
    titleText.textContent="";
    icon.textContent="⚠️";
    guide.style.display="none";
  }

  box.scrollIntoView({behavior:"smooth",block:"start"});
};

$("#check").addEventListener("click",()=>{
  const okScope = validateScope();
  const okW23   = validateW23();
  const okW26   = toggleW26Required();
  const okW29   = validateW29();

  const v = getVals();
  const w31 = calcW31(v);
  $("#w31").value = w31 ? Math.round(w31*100)/100 : "";

  if(!okScope || !okW23 || !okW26 || !okW29){
    if(!okScope && $("#w23").value) return render({type:"guide",msg:"위치구분을 선택해주세요"});
    if(!okW23) return render({type:"guide",msg:"이격거리를 입력해주세요"});
    if(!okW26) return render({type:"guide",msg:"굴착·단차 입력 시 ‘부지높이 관계’를 선택해주세요"});
    if(!okW29) return render({type:"guide",msg:"층수를 입력한 경우 건축물 높이(m)를 함께 입력해주세요"});
  }

  const res = judge(v);
  render(res);
});

/* ----------------------------------------
   방문자 통계: 클라이언트 사이드 설계
   - 쿠키(visitor_id): 사용자 식별 (브라우저 단위)
   - sessionStorage: 같은 브라우저 탭/세션 내 중복 카운트 방지
   - localStorage: 날짜별 저장 (total, unique, users[])
   확장 포인트: 서버 API로 전송하면 전체 사이트 통합 통계 가능
-----------------------------------------*/

/* Cookie 유틸 (간단) */
const Cookie = {
  get: (name) => {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : null;
  },
  set: (name, value, days=365) => {
    const d = new Date();
    d.setTime(d.getTime() + (days*24*60*60*1000));
    document.cookie = `${name}=${value}; expires=${d.toUTCString()}; path=/`;
  }
};

/* 고유 visitor id 확보 */
function getOrCreateVisitorId(){
  let id = Cookie.get('visitor_id');
  if(!id){
    id = 'v_' + Math.random().toString(36).slice(2,10);
    Cookie.set('visitor_id', id, 365*5); // 5년
  }
  return id;
}

const STORAGE_KEY = "edu_safety_visitors_v1";
const SESSION_TIMEOUT_MINUTES = 30; // 세션 유효 시간 (탭 닫으면 sessionStorage가 지워지므로 기본 동작은 탭 단위)

/* 날짜 문자열: YYYY-MM-DD */
function todayIso(){ return (new Date()).toISOString().slice(0,10); }

/* 데이터 불러오기 (안전하게) */
function loadStats(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  }catch(e){
    console.warn("stats parse error, resetting", e);
    localStorage.removeItem(STORAGE_KEY);
    return {};
  }
}

/* 저장 */
function saveStats(obj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}

/* 방문 기록 처리
   - 같은 세션(=sessionStorage에 flag 있으면)에서는 total 증가 안 함
   - unique는 users[]에 visitor_id가 없을 때만 증가
*/
function recordVisit(){
  const date = todayIso();
  const vid = getOrCreateVisitorId();
  const sessFlag = `visited_${date}`;

  const stats = loadStats();
  if(!stats[date]) stats[date] = { total:0, unique:0, users:[] };

  // total: session 기반 (한 세션당 1회만)
  if(!sessionStorage.getItem(sessFlag)){
    stats[date].total = (stats[date].total || 0) + 1;
    sessionStorage.setItem(sessFlag, String(Date.now()));
  }

  // unique: cookie(visitor_id) 기반
  if(!stats[date].users.includes(vid)){
    stats[date].unique = (stats[date].unique || 0) + 1;
    stats[date].users.push(vid);
  }

  saveStats(stats);

  /* 확장 포인트(서버 연동 예시)
     - 만약 중앙 통계(모든 방문자 기여)를 원하면 이 지점에서 fetch()로 서버에 전송하세요.
     - 예: fetch("/api/visit", {method:"POST", body: JSON.stringify({date,vid})})
  */

  return stats;
}

/* CSV 생성 */
function downloadCSV(data){
  const rows = [["date","total","unique"]];
  Object.entries(data).sort((a,b)=>a[0]<b[0] ? 1 : -1).forEach(([date, val])=>{
    rows.push([date, val.total, val.unique]);
  });
  const blob = new Blob([rows.map(r=>r.join(",")).join("\n")], {type: "text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "visitors.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ----------------------------------------
   차트 그리기 (Canvas) — 파스텔톤 + 부드럽게
   - 툴팁: 캔버스 위에서 마우스 포인터에 따라 가장 가까운 포인트 표시
-----------------------------------------*/

const canvas = $("#trend");
const ctx = canvas.getContext("2d");
const tooltip = $("#chartTooltip");

/* 차트 데이터 생성 (최근 14일) */
function getChartSeries(stats){
  const days = [...Array(14)].map((_,i)=>{
    const dd = new Date();
    dd.setDate(dd.getDate()-13+i);
    return dd.toISOString().slice(0,10);
  });
  const totals = days.map(d => (stats[d] && stats[d].total) ? stats[d].total : 0);
  return { days, totals };
}

/* 부드러운 곡선 (Catmull-Rom to Bezier approximation)
   단순화: mid-point-based smoothing for small dataset.
*/
function drawChart(days, values){
  // 고해상도 캔버스 고려 (devicePixelRatio)
  const DPR = window.devicePixelRatio || 1;
  const W = canvas.clientWidth;
  const H = canvas.clientHeight;
  canvas.width = Math.floor(W * DPR);
  canvas.height = Math.floor(H * DPR);
  canvas.style.width = W + "px";
  canvas.style.height = H + "px";
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0); // scale drawing commands

  ctx.clearRect(0,0,W,H);

  // 그래프 패딩
  const P = 14;
  const L = values.length;
  const maxV = Math.max(1, ...values);

  const X = i => P + i * (W - 2*P) / Math.max(1, L-1);
  const Y = v => H - P - (v * (H - 2*P) / maxV);

  // 배경 (subtle)
  ctx.fillStyle = "#fbfdff";
  ctx.fillRect(0,0,W,H);

  // area fill (soft pastel)
  ctx.beginPath();
  ctx.moveTo(X(0), Y(values[0]));
  for(let i=1;i<L;i++){
    // mid point smoothing
    const x0 = X(i-1), y0 = Y(values[i-1]);
    const x1 = X(i), y1 = Y(values[i]);
    const mx = (x0 + x1)/2, my = (y0 + y1)/2;
    ctx.quadraticCurveTo(x0,y0, mx, my);
  }
  ctx.lineTo(X(L-1), H - P);
  ctx.lineTo(X(0), H - P);
  ctx.closePath();
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--pastel-fill') || 'rgba(173,216,230,0.25)';
  ctx.fill();

  // line
  ctx.beginPath();
  ctx.moveTo(X(0), Y(values[0]));
  for(let i=1;i<L;i++){
    const x0 = X(i-1), y0 = Y(values[i-1]);
    const x1 = X(i), y1 = Y(values[i]);
    const mx = (x0 + x1)/2, my = (y0 + y1)/2;
    ctx.quadraticCurveTo(x0,y0, mx, my);
  }
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--pastel-line') || 'rgba(147,197,253,0.95)';
  ctx.lineWidth = 2.5;
  ctx.lineJoin = 'round';
  ctx.stroke();

  // points
  for(let i=0;i<L;i++){
    ctx.beginPath();
    ctx.arc(X(i), Y(values[i]), 3.5, 0, Math.PI*2);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--pastel-point') || 'rgba(110,231,183,0.9)';
    ctx.fill();
    // small stroke
    ctx.strokeStyle = "rgba(255,255,255,0.6)";
    ctx.lineWidth = 1;
    ctx.stroke();
  }

  // x labels (MM-DD) - show every other label if crowded
  ctx.fillStyle = "#6b7280";
  ctx.font = "10px system-ui, sans-serif";
  ctx.textAlign = "center";
  for(let i=0;i<L;i++){
    if(L<=10 || i%2===0){
      const txt = days[i].slice(5);
      ctx.fillText(txt, X(i), H - 2);
    }
  }
}

/* 캔버스 마우스 이벤트 -> 툴팁 */
function attachTooltip(days, values){
  // precompute points
  const rect = canvas.getBoundingClientRect();
  const W = canvas.clientWidth, H = canvas.clientHeight;
  const P = 14, L = values.length;
  const X = i => P + i * (W - 2*P) / Math.max(1, L-1);
  const Y = v => H - P - (v * (H - 2*P) / Math.max(1, ...values, 1));

  // event handlers
  function findNearest(mouseX, mouseY){
    let nearest = { idx: -1, dist: Infinity };
    for(let i=0;i<L;i++){
      const dx = mouseX - X(i);
      const dy = mouseY - Y(values[i]);
      const d = Math.sqrt(dx*dx + dy*dy);
      if(d < nearest.dist){
        nearest = { idx: i, dist: d };
      }
    }
    return nearest;
  }

  function onMove(e){
    const r = canvas.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;
    const nearest = findNearest(mx, my);
    const threshold = 18; // pixels sensitivity
    if(nearest.idx !== -1 && nearest.dist <= threshold){
      const i = nearest.idx;
      // position and show tooltip
      tooltip.style.display = "block";
      tooltip.setAttribute("aria-hidden","false");
      tooltip.textContent = `${days[i]} — ${values[i]}명`;
      // place tooltip near cursor but avoid overflow
      const left = e.clientX;
      const top = e.clientY - 12;
      tooltip.style.left = left + "px";
      tooltip.style.top = top + "px";
    }else{
      tooltip.style.display = "none";
      tooltip.setAttribute("aria-hidden","true");
    }
  }
  function onLeave(){
    tooltip.style.display = "none";
    tooltip.setAttribute("aria-hidden","true");
  }

  // attach
  canvas.removeEventListener("mousemove", canvas._mvHandler);
  canvas.removeEventListener("mouseleave", canvas._leaveHandler);
  canvas._mvHandler = onMove;
  canvas._leaveHandler = onLeave;
  canvas.addEventListener("mousemove", onMove);
  canvas.addEventListener("mouseleave", onLeave);
}

/* ----------------------------------------
   초기 로드: 통계 기록, 차트 렌더
-----------------------------------------*/
document.addEventListener("DOMContentLoaded", ()=>{
  // record visit and update today's count UI
  const stats = recordVisit();
  const today = todayIso();
  $("#todayCnt").textContent = stats[today] ? stats[today].total : 0;

  // create chart series
  const { days, totals } = getChartSeries(stats);
  drawChart(days, totals);
  attachTooltip(days, totals);

  // CSV 버튼
  $("#dl").addEventListener("click", ()=> {
    const s = loadStats();
    downloadCSV(s);
  });
});
})();
</script>
</body>
</html>
